version: 3

vars:
  CLUSTER: nuvolaris
  KIND_CLUSTER: '{{.CLUSTER}}-control-plane'
  KIND_IMAGE:
    sh: >
       docker inspect  {{.KIND_CLUSTER}} | jq -r '.[0].Config.Image'

tasks:

  docker-list:
    silent: true
    desc: save images in docker
    cmds:
    - awk '/image:/{print $2}' $OPS_ROOT/setup/docker/kind.yaml | tee _docker.lst

  docker-save:
    silent: true
    desc: save images in docker
    cmds:
    - task: docker-list
    - mkdir -p ~/.ops/.images/docker
    - |
      cat _docker.lst | while read img
      do
        file=~/.ops/.images/docker/{{ARCH}}-$(base64 -e "$img")
        if test -e "$file"
        then echo "already saved $img.{{ARCH}} "
        else echo ">>> Saving: $img"
             if docker pull "$img"
             then echo "OK: save $file"
             else echo "*** FAIL: pull $img"
             fi
             if docker save "$img" -o "$file"
             then echo "OK: save $file"
             else echo "*** FAIL: save $file"
             fi
        fi
      done

  kind-list:
    silent: false
    env:
      CLU: "{{.KIND_CLUSTER}}"
    desc: list images in kindes
    cmds:
    - awk '/image:/ {print $2}' $OPS_ROOT/setup/docker/ingress-deploy.yaml | tee _kind.lst
    - >
      docker exec -it "$CLU" crictl images 2>/dev/null
      | awk 'NR > 1  && !/^(registry.k8s.io\/(kube-|coredns|etc|pause|ingress-nginx)|docker.io\/kindest\/)/ {print  $1 ":" $2 }'
      | tee _kind.lst

  kind-save:
    silent: false
    desc: list images in kindes
    env:
      CLU: "{{.KIND_CLUSTER}}"
    cmds:
    - mkdir -p ~/.ops/.images/kind
    - |
      cat _kind.lst | while read img
      do
        file=~/.ops/.images/kind/$ARCH-"$(base64 -e "$img")"
        if test -e "$file"
        then echo "already saved $img"
        else echo ">>> Saving: $img"
            if !  docker pull "$img" 
            then echo "*** FAIL pull $img" ; continue
            fi
            if ! docker save "$img" -o "$file" 
            then echo "*** FAIL save $file" ; continue
            fi
            echo "OK: save $file"
        fi
      done

  save-images:
    desc: images
    cmds:
    - kind get clusters | grep {{.CLUSTER}} || die "please setup an ops cluster first"
    - task: docker-save
    - task: kind-save

  list-images:
    desc: list images
    cmds:
      - |
        rm -f _docker.lst _kind.lst
        for dir in docker kind
        do for file in ~/.ops/.images/$dir/{{ARCH}}-*
           do if test -e "$file"
              then
                b64=$(basename "$file")
                img=$(base64 -d "${b64#*-}")
                echo $dir/$img
                echo $img >>_$dir.lst
              fi
           done
        done

  clean-images:
    desc: clean images
    cmds:
    - rm -f -v  ~/.ops/.images/docker/*
    - rm -f -v  ~/.ops/.images/kind/*

  purge-images:
    desc: remove and purge images
    cmds:
    - rm -v _docker.lst _kind.lst
    - task: list
    - |
      cat _docker.lst _kind.lst | while read img
      do docker rmi -f $img
      done

  docker-load:
    silent: true
    desc: load images
    cmds:
      - |
        for file in ~/.ops/.images/docker/{{ARCH}}-*
        do             
          b64=$(basename "$file")
          img=$(base64 -d "${b64#*-}")
          echo Docker: loading "$img" 
          docker load -i "$file"
          #docker tag $(awk '{print $4}' _image) $img
          docker tag ${img#*@} ${img%@*}
        done

  kind-load:
    silent: true
    desc: load images
    cmds:
      - |
        for file in ~/.ops/.images/kind/{{ARCH}}-*
        do                 
           b64=$(basename "$file")
           img=$(base64 -d "${b64#*-}")
           echo Kind: loading $img
           kind load image-archive "$file" -n {{.CLUSTER}} --nodes {{.CLUSTER}}-control-plane
        done
